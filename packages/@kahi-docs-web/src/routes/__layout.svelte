<script context="module" lang="ts">
    import type {Load} from "@sveltejs/kit";

    import type {INavigationGet, IRouteError} from "../lib/shared/api";

    export const load: Load = async ({fetch, url}) => {
        const [, category] = url.pathname.split("/");

        if (!category) {
            return {};
        }

        const response = await fetch(`/api/v4/navigation/${category}.json`);

        if (!response.ok) {
            const data = (await response.json()) as IRouteError;

            return {
                status: response.status,
                error: data.code,
            };
        }

        const data = (await response.json()) as INavigationGet;

        return {
            stuff: {
                navigation: data.data,
            },
        };
    };
</script>

<script lang="ts">
    import "@kahi-ui/framework/dist/kahi-ui.framework.css";
    import "@kahi-ui/framework/dist/kahi-ui.theme.default.css";

    import "prismjs/themes/prism-tomorrow.css";

    import {browser} from "$app/env";
    import {page} from "$app/stores";
    import {htmlmode} from "@kahi-ui/framework";

    import {preferencetheme} from "@kahi-docs/shared";

    import AppLayout from "../lib/components/AppLayout.svelte";
    import AsideLayout from "../lib/components/AsideLayout.svelte";
    import PageMetadata from "../lib/components/PageMetadata.svelte";
    import PagePrerender from "../lib/components/PagePrerender.svelte";

    const _htmlmode = htmlmode();
    $: if (browser) $_htmlmode = $preferencetheme ?? "";
</script>

<PageMetadata />
<PagePrerender />

{#if $page.stuff.navigation}
    <AsideLayout>
        <slot />
    </AsideLayout>
{:else}
    <AppLayout>
        <slot />
    </AppLayout>
{/if}

<style>
    :global(body),
    :global(html) {
        height: 100%;
    }

    /**
     * NOTE: These styles can be used in multiple places, blog, docs, landing page, etc.
     * And typically auto generated by the Markdown parser with raw HTML. So they're
     * placed here instead of a Component.
     */

    :global(.highlight),
    :global(.repl-snippet) {
        position: relative;

        width: 100%;
        max-height: 30rem;

        border: var(--sizes-borders-tiny) solid hsla(var(--palettes-auto-foreground-bolder), 0.5);
        border-radius: calc(var(--radius-small) * 1rem);
    }

    :global(.highlight[data-mode="repl"]),
    :global(.repl-snippet) {
        /** NOTE: REPLs are fixed heights, so we need to set documentation snippets to be likewise */

        height: 30rem;
    }

    :global(.repl-snippet) {
        z-index: 0;
    }
</style>
