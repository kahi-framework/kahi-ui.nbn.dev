name: Build and Publish

on:
    workflow_run:
        workflows: ["Test"]
        branches: [main]
        types:
            - completed

jobs:
    build-and-publish:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [16.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - name: Checkout
              uses: actions/checkout@v2.3.1

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: Install
              run: |
                  mkdir ./bin
                  curl -L -o ./bin/stork.linux.x64 https://github.com/jameslittle230/stork/releases/download/v1.2.1/stork-ubuntu-latest
                  chmod +x ./bin/stork.linux.x64
                  npm ci

            - name: Build Application
              run: npm run build:application

            - name: Build Search Index
              run: |
                  npm run build:generate-index
                  npm run index:generate
                  npm run index:build
              # TODO: This is kind-of lame, but just threw together a quick hack since
              # couldn't get `ts-node` to work properly with ES Modules

            - name: Publish
              uses: JamesIves/github-pages-deploy-action@4.1.4
              with:
                  branch: gh-pages
                  folder: build
